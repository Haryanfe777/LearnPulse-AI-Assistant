================================================================================
SUPPORT TICKET ESCALATION - IMPLEMENTATION OPTIONS
================================================================================

OVERVIEW
--------
We need to handle teacher dissatisfaction by creating support tickets with 
conversation context and notifying the support team at support@learnpulse.ai.

The original prompt said:
  "tell the teacher you created a ticket and send a ticket to the email..."

Problem: The LLM cannot actually send emails or create files on its own.
         It will just SAY it did (hallucination).

Solution: We have 2 options - both are production-ready approaches used in 
          industry. Option A is already implemented and ready to test.


================================================================================
OPTION A: BACKEND-CONTROLLED ESCALATION (IMPLEMENTED ‚úÖ)
================================================================================

HOW IT WORKS
------------
1. Teacher sends messages
2. Backend tracks each message for "dissatisfaction keywords"
3. When 3 dissatisfaction signals are detected ‚Üí Backend auto-escalates:
   - Creates a .txt file with full conversation history
   - Sends email to support (if SMTP configured) or logs it (dev mode)
   - Returns ticket ID to teacher
4. LLM only acknowledges: "I've connected you with support, ticket ID: ..."

The LLM doesn't decide or perform any actions - it just acknowledges what 
the backend already did.

FLOW DIAGRAM
------------
Teacher: "This doesn't help"  ‚Üí  Backend detects dissatisfaction
                                  Backend increments counter (1)
                                  Backend continues chat
                                  
Teacher: "Still wrong"        ‚Üí  Backend detects dissatisfaction
                                  Backend increments counter (2)
                                  Backend continues chat
                                  
Teacher: "I need support"     ‚Üí  Backend detects dissatisfaction
                                  Backend increments counter (3)
                                  Backend creates ticket ‚úÖ
                                  Backend sends email (if configured)
                                  Backend returns: "ticket ID: TICKET-abc123"
                                  
Teacher sees: "I've connected you with support, ticket ID: TICKET-abc123..."


DISSATISFACTION KEYWORDS
------------------------
Backend detects these phrases (case-insensitive):
  - "not satisfied"
  - "doesn't help"
  - "still wrong"
  - "not working"
  - "i need help"
  - "speak to someone"
  - "talk to support"
  - "contact support"
  - "human support"
  - "this is wrong"
  - "not what i asked"
  - "doesn't answer"
  - "unclear"
  - "confusing"
  - "frustrated"
  - "not helpful"

Threshold: 3 detections = auto-escalate


FILES CREATED/MODIFIED
----------------------
‚úÖ src/support_tickets.py          (NEW - ticket creation logic)
‚úÖ src/routes.py                    (MODIFIED - added dissatisfaction tracking)
‚úÖ src/assistant.py                 (MODIFIED - removed hallucination risk)


TESTING OPTION A
----------------
1. Pull latest code:
   git pull origin main

2. Start backend:
   cd teacher-assistant
   uvicorn main:app --reload

3. Open Streamlit (refresh if already open)

4. Send these messages:
   "How is Aisha doing?"
   "This doesn't help"              ‚Üê dissatisfaction_count = 1
   "Still not clear"                ‚Üê dissatisfaction_count = 2  
   "I need to talk to support"      ‚Üê dissatisfaction_count = 3 ‚Üí ESCALATES!

5. Expected Result:
   - Assistant says: "I've connected you with support, ticket ID: TICKET-..."
   - Check backend logs: Should show "SUPPORT TICKET WOULD BE SENT"
   - Check folder: support_tickets/support_ticket_[session_id]_[timestamp].txt
   - File should contain full conversation history


CONFIGURATION
-------------
Development Mode (Current):
  - No SMTP config needed
  - Tickets are logged to console
  - Files are still created in support_tickets/
  
Production Mode (When Ready):
  Add to .env file:
    SMTP_HOST=smtp.gmail.com
    SMTP_PORT=587
    SMTP_USERNAME=noreply@learnpulse.ai
    SMTP_PASSWORD=your_app_password
    SMTP_FROM_EMAIL=noreply@learnpulse.ai
    
  Then update src/routes.py line ~425:
    smtp_config = {
        "host": os.getenv("SMTP_HOST"),
        "port": int(os.getenv("SMTP_PORT", 587)),
        "username": os.getenv("SMTP_USERNAME"),
        "password": os.getenv("SMTP_PASSWORD"),
        "from_email": os.getenv("SMTP_FROM_EMAIL")
    }
    
    ticket_result = create_support_ticket(..., smtp_config=smtp_config)


PROS OF OPTION A
----------------
‚úÖ No hallucination - backend controls everything
‚úÖ 100% testable - deterministic behavior
‚úÖ Easy to monitor - all actions are logged
‚úÖ Simple to debug - check backend logs
‚úÖ Easy to iterate - change logic without touching LLM
‚úÖ Works immediately - no SMTP needed for dev/testing


CONS OF OPTION A
----------------
‚ö†Ô∏è Less "agentic" - LLM doesn't decide when to escalate
‚ö†Ô∏è Fixed threshold - must change code to adjust (currently 3 signals)


================================================================================
OPTION B: LLM TOOL/FUNCTION CALLING (NOT IMPLEMENTED)
================================================================================

HOW IT WORKS
------------
1. Define a "tool" that the LLM can call: create_support_ticket()
2. LLM prompt says: "If teacher is dissatisfied, call create_support_ticket"
3. LLM decides when to escalate based on conversation context
4. When LLM calls the tool, backend validates and executes it
5. Backend creates ticket, sends email, returns result to LLM
6. LLM tells teacher: "I've created a ticket for you"


FLOW DIAGRAM
------------
Teacher: "This doesn't help"  ‚Üí  LLM analyzes conversation
                                  LLM decides: not severe enough yet
                                  LLM continues helping
                                  
Teacher: "Still wrong"        ‚Üí  LLM analyzes conversation
                                  LLM decides: teacher is frustrated
                                  LLM calls: create_support_ticket(
                                      user_id="teacher123",
                                      issue="Teacher frustrated after 2 attempts",
                                      conversation=[...]
                                  )
                                  
Backend receives tool call    ‚Üí  Backend validates inputs
                                  Backend creates ticket ‚úÖ
                                  Backend sends email
                                  Backend returns: "ticket ID: TICKET-abc123"
                                  
LLM receives response         ‚Üí  LLM tells teacher: "I've created ticket..."


HOW TO IMPLEMENT OPTION B
--------------------------
1. Define the tool in src/vertex_client.py:

from vertexai.generative_models import Tool, FunctionDeclaration

support_tool = Tool(
    function_declarations=[
        FunctionDeclaration(
            name="create_support_ticket",
            description="Escalate to human support when teacher is dissatisfied",
            parameters={
                "type": "object",
                "properties": {
                    "user_id": {
                        "type": "string",
                        "description": "Teacher's user ID"
                    },
                    "issue_summary": {
                        "type": "string",
                        "description": "Brief summary of the issue"
                    },
                    "conversation_excerpt": {
                        "type": "string",
                        "description": "Key parts of conversation showing frustration"
                    }
                },
                "required": ["user_id", "issue_summary"]
            }
        )
    ]
)


2. Update src/vertex_client.py to use tools:

def get_model():
    return GenerativeModel(
        "gemini-1.5-flash-002",
        tools=[support_tool],  # ‚Üê Add this
        system_instruction=SYSTEM_INSTRUCTION
    )


3. Update src/assistant.py system prompt:

SUPPORT ESCALATION
If a teacher indicates dissatisfaction after multiple clarification attempts,
call the create_support_ticket function with:
  - user_id: the teacher's user ID
  - issue_summary: brief description of the problem
  - conversation_excerpt: 3-5 key messages showing the issue

Examples of when to escalate:
  - Teacher says "this doesn't help" 2+ times
  - Teacher explicitly asks to talk to support
  - Teacher shows clear frustration ("waste of time", "useless")


4. Update src/routes.py to handle tool calls:

# After sending message to LLM
response = chat.send_message(req.message)

# Check if LLM called a function
if response.candidates[0].content.parts[0].function_call:
    function_call = response.candidates[0].content.parts[0].function_call
    
    if function_call.name == "create_support_ticket":
        # Extract parameters
        args = function_call.args
        
        # Validate inputs
        if not args.get("user_id") or not args.get("issue_summary"):
            raise ValueError("Missing required fields")
        
        # Create ticket
        ticket_result = create_support_ticket(
            session_id=base_session_id,
            user_info={
                "email": current_user.email,
                "name": current_user.name,
                "user_id": args.get("user_id"),
                "role": current_user.role
            },
            conversation_history=state["conversation_history"],
            issue_summary=args.get("issue_summary"),
            smtp_config=None  # or add SMTP config
        )
        
        # Send function result back to LLM
        function_response = FunctionResponse(
            name="create_support_ticket",
            response={
                "success": True,
                "ticket_id": ticket_result["ticket_id"]
            }
        )
        
        # Get LLM's final response
        final_response = chat.send_message(function_response)
        reply = final_response.text
        
        return {"session_id": base_session_id, "reply": reply}


TESTING OPTION B
----------------
1. Implement the 4 steps above

2. Start backend:
   uvicorn main:app --reload

3. Send these messages:
   "How is Aisha doing?"
   "This doesn't help, I need better information"
   "I want to talk to a human"
   
4. Expected Result:
   - LLM detects frustration
   - LLM calls create_support_ticket tool
   - Backend creates ticket
   - LLM tells teacher: "I've created a support ticket..."
   - Check support_tickets/ folder for .txt file


PROS OF OPTION B
----------------
‚úÖ More "intelligent" - LLM decides based on context, not just keywords
‚úÖ More flexible - LLM can escalate at 1 signal if severe, or 5 if minor
‚úÖ Natural conversation - LLM can explain why it's escalating
‚úÖ Handles edge cases - LLM can detect frustration not in keyword list


CONS OF OPTION B
-----------------
‚ö†Ô∏è More complex - requires tool setup and function handling
‚ö†Ô∏è Less deterministic - LLM might forget to call tool
‚ö†Ô∏è Harder to test - behavior varies based on LLM interpretation
‚ö†Ô∏è Debugging is harder - need to check LLM logs for tool calls
‚ö†Ô∏è Prompt engineering - need to tune when LLM should escalate
‚ö†Ô∏è Could escalate too early/late - LLM judgment isn't perfect


================================================================================
COMPARISON
================================================================================

Criteria                    Option A (Backend)    Option B (LLM Tools)
-------------------------   --------------------  ---------------------
Implementation Time         ‚úÖ Already done       ‚ö†Ô∏è 2-3 hours work
Complexity                  ‚úÖ Simple             ‚ö†Ô∏è More complex
Reliability                 ‚úÖ 100% deterministic ‚ö†Ô∏è LLM-dependent
Testability                 ‚úÖ Easy to test       ‚ö†Ô∏è Harder to test
Debugging                   ‚úÖ Check backend logs ‚ö†Ô∏è Check LLM + backend
Intelligence                ‚ö†Ô∏è Keyword-based      ‚úÖ Context-aware
Flexibility                 ‚ö†Ô∏è Fixed threshold    ‚úÖ Adaptive
Maintenance                 ‚úÖ Easy to change     ‚ö†Ô∏è Requires re-prompting
Hallucination Risk          ‚úÖ Zero risk          ‚ö†Ô∏è Small risk
Works without SMTP          ‚úÖ Yes (logs only)    ‚úÖ Yes (logs only)


================================================================================
RECOMMENDATION
================================================================================

Start with OPTION A (already implemented) because:

1. ‚úÖ It's already done and ready to test
2. ‚úÖ It's simpler and more reliable for early-stage products
3. ‚úÖ You can always upgrade to Option B later if needed
4. ‚úÖ 99% of production SaaS apps use backend-controlled escalation
5. ‚úÖ No hallucination risk - teachers get real ticket IDs

You can switch to Option B later if you find:
  - Teachers complain that 3 signals is too many/few
  - Keyword detection misses some cases of frustration
  - You want the assistant to explain why it's escalating

But for now, Option A is the industry-standard, production-ready approach.


================================================================================
WHAT TO TEST
================================================================================

MUST TEST (Critical):
--------------------
1. ‚úÖ Normal conversation - no escalation
   Ask: "How is Aisha doing?"
   Expected: Normal response, no ticket

2. ‚úÖ 1-2 dissatisfaction signals - no escalation yet
   Say: "This doesn't help"
   Expected: Assistant tries to help better, no ticket

3. ‚úÖ 3 dissatisfaction signals - auto-escalate
   Say: "I need to talk to support"
   Expected: "I've connected you with support, ticket ID: ..."
   Check: support_tickets/ folder has new .txt file
   Check: Backend logs show "SUPPORT TICKET WOULD BE SENT"

4. ‚úÖ Ticket file contents
   Open: support_tickets/support_ticket_[session_id]_[timestamp].txt
   Expected: Full conversation history, teacher info, timestamp

5. ‚úÖ Duplicate escalation prevention
   After escalation, say: "Still not happy"
   Expected: No second ticket created (escalated=True flag prevents it)


NICE TO TEST (Optional):
------------------------
1. Different dissatisfaction phrases
   Try: "unclear", "frustrated", "not what i asked"
   Expected: Should all increment counter

2. Session persistence
   Escalate, then refresh page and start new session
   Expected: Counter resets to 0 (new session)

3. Case-insensitivity
   Try: "THIS DOESN'T HELP", "this DOESN'T help"
   Expected: Both detected


================================================================================
TROUBLESHOOTING
================================================================================

PROBLEM: No ticket file created
SOLUTION: Check backend logs for errors
          Check that support_tickets/ folder exists (auto-created)
          Check src/routes.py line ~425 - is create_support_ticket called?

PROBLEM: Counter not incrementing
SOLUTION: Check backend logs - search for "Dissatisfaction detected"
          Try exact phrases from keyword list in src/support_tickets.py
          Check that message is lowercase before matching

PROBLEM: Backend logs show no output
SOLUTION: Check that Redis is running (or fallback to in-memory)
          Check that backend started without errors
          Try: curl http://127.0.0.1:8000/health

PROBLEM: Escalation happens too early/late
SOLUTION: Change ESCALATION_THRESHOLD in src/support_tickets.py line 18
          Default is 3, try 2 (more sensitive) or 4 (less sensitive)


================================================================================
QUESTIONS FOR YOUR TEAMMATE
================================================================================

After testing, please report:

1. Did Option A work correctly? (auto-escalation at 3 signals)
2. Did the .txt file get created with full conversation?
3. Did backend logs show "SUPPORT TICKET WOULD BE SENT"?
4. Are there any false positives? (escalation when teacher wasn't frustrated)
5. Are there any false negatives? (missed escalation when teacher was frustrated)
6. Should we adjust the threshold? (2, 3, or 4 signals)
7. Should we add more keywords? (any phrases we missed)
8. Do you think we need Option B's intelligence? Or is Option A sufficient?


================================================================================
CONTACT
================================================================================

Questions? Issues?
- Check: SUPPORT_ESCALATION_IMPLEMENTATION.md (detailed guide)
- Check: src/support_tickets.py (all code is commented)
- Check: Backend logs (search for "dissatisfaction" or "escalation")

Good luck testing! üöÄ

