# Cloud Build configuration for LearnPulse AI Teaching Assistant
# Triggered on git push to main branch - deploys both backend and frontend

steps:
  # Step 1: Build Backend API Image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Build Backend'
    args: [
      'build',
      '-t', 'us-central1-docker.pkg.dev/$PROJECT_ID/learnpulse-repo/learnpulse-assistant:$SHORT_SHA',
      '-t', 'us-central1-docker.pkg.dev/$PROJECT_ID/learnpulse-repo/learnpulse-assistant:latest',
      '-f', 'Dockerfile',
      '.'
    ]
  
  # Step 2: Build Frontend Image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Build Frontend'
    args: [
      'build',
      '-t', 'us-central1-docker.pkg.dev/$PROJECT_ID/learnpulse-repo/learnpulse-frontend:$SHORT_SHA',
      '-t', 'us-central1-docker.pkg.dev/$PROJECT_ID/learnpulse-repo/learnpulse-frontend:latest',
      '-f', 'Dockerfile.streamlit',
      '.'
    ]
  
  # Step 3: Push Backend Image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Push Backend'
    args: ['push', '--all-tags', 'us-central1-docker.pkg.dev/$PROJECT_ID/learnpulse-repo/learnpulse-assistant']
  
  # Step 4: Push Frontend Image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Push Frontend'
    args: ['push', '--all-tags', 'us-central1-docker.pkg.dev/$PROJECT_ID/learnpulse-repo/learnpulse-frontend']
  
  # Step 5: Deploy Backend to Cloud Run
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'Deploy Backend'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'deploy'
      - 'learnpulse-assistant'
      - '--image=us-central1-docker.pkg.dev/$PROJECT_ID/learnpulse-repo/learnpulse-assistant:$SHORT_SHA'
      - '--region=us-central1'
      - '--platform=managed'
      - '--allow-unauthenticated'
      - '--set-env-vars=ENVIRONMENT=production,PROJECT_ID=$PROJECT_ID,REGION=us-central1,BQ_DATASET=learnpulse_data,BQ_TABLE=game_logs,DEBUG=false'
      - '--set-secrets=JWT_SECRET_KEY=jwt-secret-key:latest'
      - '--memory=512Mi'
      - '--cpu=1'
      - '--min-instances=0'
      - '--max-instances=10'
      - '--timeout=300'
      - '--service-account=learnpulse-ai@$PROJECT_ID.iam.gserviceaccount.com'
  
  # Step 6: Get Backend URL for Frontend
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'Get Backend URL'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        BACKEND_URL=$(gcloud run services describe learnpulse-assistant --region=us-central1 --format='value(status.url)')
        echo "BACKEND_URL=$BACKEND_URL" > /workspace/backend_url.env
  
  # Step 7: Deploy Frontend to Cloud Run
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'Deploy Frontend'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        source /workspace/backend_url.env
        gcloud run deploy learnpulse-frontend \
          --image=us-central1-docker.pkg.dev/$PROJECT_ID/learnpulse-repo/learnpulse-frontend:$SHORT_SHA \
          --region=us-central1 \
          --platform=managed \
          --allow-unauthenticated \
          --set-env-vars="API_URL=$BACKEND_URL" \
          --memory=512Mi \
          --cpu=1 \
          --min-instances=0 \
          --max-instances=10 \
          --timeout=300 \
          --service-account=learnpulse-ai@$PROJECT_ID.iam.gserviceaccount.com

# Container images to publish
images:
  - 'us-central1-docker.pkg.dev/$PROJECT_ID/learnpulse-repo/learnpulse-assistant:$SHORT_SHA'
  - 'us-central1-docker.pkg.dev/$PROJECT_ID/learnpulse-repo/learnpulse-assistant:latest'
  - 'us-central1-docker.pkg.dev/$PROJECT_ID/learnpulse-repo/learnpulse-frontend:$SHORT_SHA'
  - 'us-central1-docker.pkg.dev/$PROJECT_ID/learnpulse-repo/learnpulse-frontend:latest'

# Build options
options:
  machineType: 'E2_HIGHCPU_8'
  logging: CLOUD_LOGGING_ONLY
  
# Timeout (30 minutes for both builds)
timeout: '1800s'
